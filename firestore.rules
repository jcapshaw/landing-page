rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }
    
    function isValidDailyLogEntry() {
      let requiredFields = [
        'date', 'hasAppointment', 'salesperson', 'stockNumber', 
        'voi', 'hasTrade', 'customerPhone', 'status', 'customerName'
      ];
      
      let hasAllRequiredFields = requiredFields.hasAll(request.resource.data.keys());
      
      let hasValidStatus = request.resource.data.status in ['SOLD!', 'DEPOSIT', 'NO DEAL', 'PENDING'];
      let hasValidAppointment = request.resource.data.hasAppointment in ['YES', 'NO'];
      let hasValidTrade = request.resource.data.hasTrade in ['YES', 'NO'];
      
      return hasAllRequiredFields && hasValidStatus && hasValidAppointment && hasValidTrade;
    }
    
    function isValidVehicle() {
      // Add validation for vehicle data structure
      return request.resource.data.keys().hasAny(['stockNumber', 'make', 'model']);
    }
    
    function isValidProspect() {
      // Add validation for prospect data structure
      return request.resource.data.keys().hasAny(['name', 'phone']);
    }
    
    // Prospects collection
    match /prospects/{prospectId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidProspect();
      allow update: if isSignedIn() && isValidProspect();
      allow delete: if isSignedIn();
    }
    
    // Vehicles collection
    match /vehicles/{vehicleId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidVehicle();
      allow update: if isSignedIn() && isValidVehicle();
      allow delete: if isSignedIn();
    }
    
    // Daily Logs collection
    match /dailyLogs/{logId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidDailyLogEntry();
      allow update: if isSignedIn() && isValidDailyLogEntry();
      allow delete: if isSignedIn();
    }
    
    // Board Deals collection
    match /boardDeals/{dealId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}